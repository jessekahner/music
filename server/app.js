// Generated by CoffeeScript 1.6.1
(function(){var e;e={io:null,redis:require("redis"),redisWorker:null,fs:null,httpServer:null,express:null,config:{port:8080,redisHost:"top.30mars.ca",redisPort:6379,redisDatabase:2,wwwPath:"./../www/"},tempUserSessions:{session1:{name:"Alex",id:"test"},whatever:{name:"BENOIT",id:"test"},whenever:{name:"Alex",id:"test"}},trendingAlbums:[{type:"med",image_url:"http://0.static.wix.com/media/cec8b8_bcbae9b705b89190a82a0dd200a03348.jpg_512",artist:"Macklemore & Ryan Lewis",name:"The Heist"},{type:"",image_url:"http://userserve-ak.last.fm/serve/_/88057565/Believe.png",artist:"Cher",name:"Believe"},{type:"huge",image_url:"http://userserve-ak.last.fm/serve/_/90656285/Gold+PNG.png",artist:"Sir Sly",name:"Gold [ep]"},{type:"med",image_url:"http://userserve-ak.last.fm/serve/_/84554553/Enema+of+the+State+6a00e54f9153e08833016766c18afa.jpg",artist:"Blink 182",name:"Enema Of The State"}],init:function(t){var n;this.fs=require("fs");n=require("express");this.express=n.call(this);this.httpServer=require("http").createServer(this.express);this.httpServer.listen(this.config.port);this.io=require("socket.io").listen(this.httpServer);this.io.set("log level",1);this.express.get("/api/*",this._handleAPICalls);this.express.post("/api/*",this._handleAPICalls);this.express.get("/*",this._handleHttpRequest);this.express.post("/upload/",function(e,t){return console.log(JSON.stringify(e.files))});this.express.use(n.bodyParser({uploadDir:"/tmp/"}));this.express.use(function(e,t,n,r){console.error(e.stack);return n.send(500,"Oops ! Something went super wrong.")});this.redisWorker=this.redis.createClient(e.config.redisPort,e.config.redisHost);return this.io.on("connection",function(t){t.on("authenticate",function(n){if(e.tempUserSessions[n]!=null)return t.emit("userData",e.tempUserSessions[n])});return t.on("getTrendingAlbums",function(t){return t(e.trendingAlbums)})})},_handleUpload:function(e,t){var n,r;console.log(e);if(e.files!=null){r=[];for(n in e.files)r.push(console.log(e.files));return r}},_handleAPICalls:function(t,n){var r,i,s,o,u;s=t.url.split("?")[0].split("/");if(s.length<4){n.writeHead("500");n.end("API calls expect at least a module/parameter combo.");return}i=s[2];r=s[3];switch(i){case"vote":u={identity:t.connection.remoteAddress,type:"like"};t.headers["X-Real-IP"]!=null&&(u.identity=t.headers["X-Real-IP"]);o=e._registerVote(r,u);if(o){n.writeHead("200");return n.end(JSON.stringify({status:"ok",value:o}))}n.writeHead("500");return n.end(JSON.stringify({status:"failed"}));default:n.writeHead("404");return n.end("Module "+i+" not found")}},_registerVote:function(t,n){var r,i,s;r={laval:0,montreal:1,longueuil:2,quebec:3};if(t==null||r[t]==null)return!1;i="votes:"+t;console.log("New vote for "+t+" from "+n.identity);s={city:t,type:n.type};if(n.type==="call"){n.identity=(n.identity+"").split(",")[0];s.tel=n.identity.substr(0,n.identity.length-2)}e.io.sockets.emit("vote",s);e.tickerData.push(s);e.tickerData.length>e.tickerMaxLength&&e.tickerData.splice(0,e.tickerData.length-e.tickerMaxLength);return n.type==="call"?e.redisWorker.zadd("maireacademie:votes:"+t,(new Date).getTime(),JSON.stringify(n)):e.redisWorker.zadd("maireacademie:votes:fb:"+t,(new Date).getTime(),JSON.stringify(n))},_handleHttpRequest:function(t,n){var r,i;r=t.url.split("?")[0];r=r==="/"?"index.php":r;r=r.split("..").join("");i=__dirname+"/"+e.config.wwwPath+r;return e.fs.readFile(i,function(e,t){if(e){n.writeHead("500");return n.end("Error loading "+r)}n.writeHead("200");return n.end(t)})}};e.init()}).call(this);